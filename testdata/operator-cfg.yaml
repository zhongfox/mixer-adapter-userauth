apiVersion: "config.istio.io/v1alpha2"
kind: handler
metadata:
  name: userauth
  namespace: istio-system
spec:
  adapter: userauth
  connection:
    #address: "[::]:8888"
    address: "authadapter.istio-system.svc.cluster.local:8888"
  params:
    token: "authserver.istio-system.svc.cluster.local:9999"
---

apiVersion: "config.istio.io/v1alpha2"
kind: instance
metadata:
  name: userauth
  namespace: istio-system
spec:
  template: authorization
  params:
    subject:
      properties:
        token: request.headers["cookie"]
        host: request.host
---

apiVersion: "config.istio.io/v1alpha2"
kind: rule
metadata:
  name: userauth
  namespace: istio-system
spec:
  #match: request.host == "localhost"
  match: match(destination.service.host, "server.*")
  actions:
  - handler: userauth
    instances:
    - userauth
---
