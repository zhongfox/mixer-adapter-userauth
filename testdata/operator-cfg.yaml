apiVersion: "config.istio.io/v1alpha2"
kind: handler
metadata:
  name: userauth
  namespace: istio-system
spec:
  adapter: userauth
  connection:
    #address: "[::]:8888"
    address: "authadapter.istio-system.svc.cluster.local:8888"
  params:
    token: "authserver.istio-system.svc.cluster.local:9999"
---

apiVersion: "config.istio.io/v1alpha2"
kind: instance
metadata:
  name: userauth
  namespace: istio-system
spec:
  template: authorization
  params:
    subject:
      properties:
        cookie: request.headers["cookie"]
        user_id: request.headers["user_id"]
        language: request.headers["language"]
        websig: request.headers["websig"]
        tasksig: request.headers["tasksig"]
        oa_uid: request.headers["oa_uid"]
        oa_token: request.headers["oa_token"]
        source_workload_namespace: source.workload.namespace
        source_workload_name: source.workload.name
        destination_workload_namespace: destination.workload.namespace
        destination_workload_name: destination.workload.name
        destination_service_namespace: destination.service.namespace
        destination_service_name: destination.service.name
        request_url_path: request.url_path
---

apiVersion: "config.istio.io/v1alpha2"
kind: rule
metadata:
  name: userauth
  namespace: istio-system
spec:
  #match: request.host == "localhost"
  match: match(destination.service.host, "server.*")
  actions:
  - handler: userauth
    instances:
    - userauth
---
